function drawFollowEye(a,b,c,d,e,f,g,h,i){$(".ufo").append("<div class='"+a+"'><div class='"+b+"'></div></div>"),a="."+a,b="."+b,$(a).css({left:c,top:d}),$(b).css({width:i,height:h}),$(a).css({width:e,height:e}),$(b).css({position:"relative","border-radius":"50%"}),$(a).css({position:"absolute",overflow:"hidden","border-radius":"50%"});var j=$(b).width()/2,k={x:$(a).width()/2-j,y:$(a).height()/2-j},l=$(a).width()/2-j,m=k.x,n=k.y;$(window).mousemove(function(a){var b={x:a.pageX-j-f-k.x,y:a.pageY-j-g-k.y},c=Math.sqrt(b.x*b.x+b.y*b.y);c<l?(m=a.pageX-f-j,n=a.pageY-g-j):(m=b.x/c*l+k.x,n=b.y/c*l+k.y)});var b=$(b),o=k.x,p=k.y;loop=setInterval(function(){o+=(m-o)/5,p+=(n-p)/5,b.css({left:o,top:p})},5)}$.fn.tetris=function(a){return a=$.extend({width:10,height:22,cellSize:30,speed:1,speedDecrease:40,speedDecreaseLevel:10,minSpeed:75,backgroundColor:"#000000",strokeColor:"#030314",errorColor:"#FF0000",overlaySelector:".overlay",scoreSelector:".score",speedSelector:".speed",canvasSelector:".canvas-map",canvasNextPieceSelector:".canvasNextPiece",ufoSelector:".ufo",balloonSelector:".balloon",resultsSelector:".results",playPauseSelector:".play-pause",playPauseTouchButton:".touch-pause-button"},a),this.each(function(){function o(){l=new Array(n);for(var a=0;a<n;a++){l[a]=new Array(m);for(var b=0;b<m;b++)l[a][b]=0}}function t(){s?(r=Math.floor(Math.random()*k.length),q=Math.floor(Math.random()*k.length),s=!1):(q=r,r=Math.floor(Math.random()*k.length)),N(),p={position:{x:k[q].startPosition.x,y:k[q].startPosition.y},prevPosition:{x:k[q].startPosition.x,y:k[q].startPosition.y},rotation:0,blockType:k[q]},u()?w():(z(),L(),nb(jb))}function u(){for(var a=0;a<j;a++)for(var b=0;b<i;b++)if(1==p.blockType.blocks[p.rotation][a][b]){var c=l[a+p.position.y][b+p.position.x];if(c>=2&&c<=8)return!0}}function w(){wb=!1,v=!0,A(),M(),setTimeout(function(){x()},1e3)}function x(){$(a.overlaySelector).find(a.playPauseSelector).hide(),$(a.overlaySelector).addClass("active").find(a.resultsSelector).show().find(a.scoreSelector).text(db)}function y(){for(var a=0;a<j;a++)for(var b=0;b<i;b++){var c=l[a+p.prevPosition.y][b+p.prevPosition.x];(c<2||c>8)&&(l[a+p.prevPosition.y][b+p.prevPosition.x]=0)}}function z(){y();for(var a=0;a<j;a++)for(var b=0;b<i;b++){var c=l[a+p.position.y][b+p.position.x];(c<2||c>8)&&(l[a+p.position.y][b+p.position.x]=p.blockType.blocks[p.rotation][a][b])}}function A(){y();for(var a=0;a<j;a++)for(var b=0;b<i;b++)1==p.blockType.blocks[p.rotation][a][b]&&(l[a+p.position.y][b+p.position.x]="x")}function B(){for(var a=0;a<j;a++)for(var b=0;b<i;b++)1==p.blockType.blocks[p.rotation][a][b]&&(l[a+p.position.y][b+p.position.x]=p.blockType.number+1)}function G(){C.attr("width",a.width*a.cellSize),C.attr("height",a.height*a.cellSize),D.fillStyle=a.backgroundColor,D.fillRect(0,0,a.width*a.cellSize,a.height*a.cellSize),D.strokeStyle=a.strokeColor,D.lineWidth=1,E=C.offset().left,F=C.offset().top}function J(){H.attr("width",i*a.cellSize),H.attr("height",j*a.cellSize),I.fillStyle=a.backgroundColor,I.fillRect(0,0,a.width*a.cellSize,a.height*a.cellSize),I.strokeStyle=a.strokeColor,I.lineWidth=1}function K(){for(var b=0;b<j;b++)for(var c=0;c<i;c++){var d=l[b+p.prevPosition.y][c+p.prevPosition.x];(d<2||d>8)&&(D.fillStyle=a.backgroundColor,D.fillRect((c+p.prevPosition.x-2)*a.cellSize,(b+p.prevPosition.y-2)*a.cellSize,a.cellSize,a.cellSize))}}function L(){K();for(var b=0;b<j;b++)for(var c=0;c<i;c++){var d=l[b+p.position.y][c+p.position.x];d>=2&&d<=8?(D.fillStyle=k[d-2].color,D.fillRect((c+p.position.x-2)*a.cellSize,(b+p.position.y-2)*a.cellSize,a.cellSize,a.cellSize),D.strokeRect((c+p.position.x-2)*a.cellSize+2,(b+p.position.y-2)*a.cellSize+2,a.cellSize-4,a.cellSize-4)):1==d?(D.fillStyle=p.blockType.color,D.fillRect((c+p.position.x-2)*a.cellSize,(b+p.position.y-2)*a.cellSize,a.cellSize,a.cellSize),D.strokeRect((c+p.position.x-2)*a.cellSize+2,(b+p.position.y-2)*a.cellSize+2,a.cellSize-4,a.cellSize-4)):0==d&&(D.fillStyle=a.backgroundColor,D.fillRect((c+p.position.x-2)*a.cellSize,(b+p.position.y-2)*a.cellSize,a.cellSize,a.cellSize))}}function M(){for(var b=0;b<j;b++)for(var c=0;c<i;c++){var d=l[b+p.position.y][c+p.position.x];"x"==d&&(D.shadowColor=a.errorColor,D.shadowBlur=a.cellSize,D.shadowOffsetX=0,D.shadowOffsetY=0,D.fillStyle=a.errorColor,D.fillRect((c+p.position.x-2)*a.cellSize,(b+p.position.y-2)*a.cellSize,a.cellSize,a.cellSize),D.strokeRect((c+p.position.x-2)*a.cellSize+2,(b+p.position.y-2)*a.cellSize+2,a.cellSize-4,a.cellSize-4))}}function N(){for(var b=0;b<j;b++)for(var c=0;c<i;c++){var d=k[r].blocks[0][b][c];I.fillStyle=a.backgroundColor,I.fillRect(c*a.cellSize,b*a.cellSize,a.cellSize,a.cellSize),1==d&&(I.fillStyle=k[r].color,I.fillRect(c*a.cellSize,b*a.cellSize,a.cellSize,a.cellSize),I.strokeRect(c*a.cellSize+2,b*a.cellSize+2,a.cellSize-4,a.cellSize-4))}}function Q(){$(document).keydown(function(a){switch(a.which){case 38:return wb&&Y(),!1;case 40:return wb&&X(3),!1;case 39:return wb&&X(2),!1;case 37:return wb&&X(0),!1;case 80:return v||ob(),!1}})}function R(){$("body").swipe({swipeLeft:function(){wb&&X(0)},swipeRight:function(){wb&&X(2)},swipeDown:function(){wb&&X(3)},swipeUp:function(){wb&&Y()},threshold:20}),$(a.playPauseTouchButton).click(function(){v||pb()})}function T(b,c,d){for(var e=0;e<j;e++)for(var f=0;f<i;f++)if(1==p.blockType.blocks[d][e][f]){if(f+b>=a.width+2)return S="right","border";if(f+b<=1)return S="left","border";if(e+c<=1)return S="top","border";if(e+c>=a.height+2)return S="bottom","border";var g=l[e+c][f+b];if(g>=2&&g<=8)return"piece"}}function W(){U=p.position.x*a.cellSize+E,V=p.position.y*a.cellSize+F,$(window).trigger("updateEyePosition")}function X(a){var b=p.position.x+O[a],c=p.position.y+P[a],d=T(b,c,p.rotation);"border"!==d?"piece"!==d?(p.prevPosition.x=p.position.x,p.prevPosition.y=p.position.y,p.position.x+=O[a],p.position.y+=P[a],z(),L()):3==a&&Z():"bottom"==S&&Z(),W()}function Y(){if(p.rotation<3)var a=p.rotation+1;else var a=0;var b=T(p.position.x,p.position.y,a);"border"!==b&&"piece"!==b&&(p.rotation=a,z(),L())}function Z(){clearInterval(mb),B(),ab(),t()}function ab(){for(var a=0;a<n;a++){_[a]=0;for(var b=0;b<m;b++)l[a][b]>=2&&l[a][b]<=8&&_[a]++}fb()}function fb(){bb=!1;for(var b=n-1,c=0;b>=0;--b)if(_[b]>=a.width)bb=!0,++c,++db,lb();else for(var d=0;d<m;d++)l[b+c][d]=l[b][d];for(b=0;b<c;++b)for(var d=0;d<m;d++)l[b][d]=0;bb&&(vb(c),hb(),gb())}function gb(){for(var b=0;b<a.height;b++)for(var c=0;c<a.width;c++){var d=l[b+2][c+2];d>=2&&d<=8?(D.fillStyle=k[d-2].color,D.fillRect(c*a.cellSize,b*a.cellSize,a.cellSize,a.cellSize),D.strokeRect(c*a.cellSize+2,b*a.cellSize+2,a.cellSize-4,a.cellSize-4)):1==d?(D.fillStyle=p.blockType.color,D.fillRect(c*a.cellSize,b*a.cellSize,a.cellSize,a.cellSize),D.strokeRect(c*a.cellSize+2,b*a.cellSize+2,a.cellSize-4,a.cellSize-4)):0==d&&(D.fillStyle=a.backgroundColor,D.fillRect(c*a.cellSize,b*a.cellSize,a.cellSize,a.cellSize))}}function hb(){$(a.scoreSelector).find(".value").text(db),$(a.speedSelector).find(".value").text(a.speed)}function kb(){var b=ib-a.speed*a.speedDecrease;b>=a.minSpeed&&(jb=b,a.speed++,tb=!0)}function lb(){db>=eb*a.speedDecreaseLevel&&(eb++,kb())}function nb(a){mb=setInterval(function(){X(3)},a)}function ob(){1==wb?(wb=!1,clearInterval(mb),$(a.overlaySelector).find(".glyphicon").removeClass("glyphicon-play").addClass("glyphicon-pause"),$(a.overlaySelector).addClass("active")):(wb=!0,nb(jb),$(a.overlaySelector).find(".glyphicon").removeClass("glyphicon-pause").addClass("glyphicon-play"),$(a.overlaySelector).removeClass("active"))}function pb(){1==wb?(wb=!1,clearInterval(mb),$(a.playPauseTouchButton).find(".glyphicon").removeClass("glyphicon-pause").addClass("glyphicon-play")):(wb=!0,nb(jb),$(a.playPauseTouchButton).find(".glyphicon").removeClass("glyphicon-play").addClass("glyphicon-pause"))}function sb(b,c,d,e,f,g,h,i,k){$(a.ufoSelector).append("<div class='"+b+"'><div class='"+c+"'></div></div>"),b="."+b,c="."+c,$(b).css({left:d,top:e}),$(c).css({width:k,height:i}),$(b).css({width:f,height:f}),$(c).css({position:"relative","border-radius":"50%"}),$(b).css({position:"absolute",overflow:"hidden","border-radius":"50%"});var l=$(c).width()/2,m={x:$(b).width()/2-l,y:$(b).height()/2-l},n=$(b).width()/2-l,o=m.x,p=m.y;$(window).on("updateEyePosition",function(){var a={x:U-l-g-m.x,y:V+j-l-h-m.y},b=Math.sqrt(a.x*a.x+a.y*a.y);b<n?(o=U-g-l,p=V-h-l):(o=a.x/b*n+m.x,p=a.y/b*n+m.y),$(c).css({left:o+"px",top:p+"px"})})}function vb(b){var c="left";if(tb){if(1==b)var d="You got "+b+" point and increased speed to "+a.speed+".";else var d="You got "+b+" points and increased speed to "+a.speed+".";c="left",tb=!1}else{if(1==b)var d="You got "+b+" point.";else var d="You got "+b+" points.";c="center"}$(a.balloonSelector).css({"text-align":c}).find("p").text(d),$(a.balloonSelector).hasClass("active")?ub=!0:$(a.balloonSelector).addClass("active"),setTimeout(function(){ub?ub=!1:$(a.balloonSelector).removeClass("active")},2e3)}function xb(){wb=!0,o(),G(),J(),t(),Q(),Modernizr.touch&&R(),hb(),sb("eye-container","eye",40,26,40,qb,rb,26,26),W()}var q,r,E,F,S,U,V,bb,mb,wb,b={blocks:[[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]]],startPosition:{x:5,y:1},number:1,color:"#ff6138"},c={blocks:[[[1,0,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[1,1,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:2,color:"#876b35"},d={blocks:[[[0,0,1,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],[[1,1,0,0],[0,1,0,0],[0,1,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:3,color:"#6b8d35"},e={blocks:[[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:4,color:"#276868"},f={blocks:[[[0,1,1,0],[1,1,0,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,0,1,0],[0,0,0,0]],[[0,0,0,0],[0,1,1,0],[1,1,0,0],[0,0,0,0]],[[1,0,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:5,color:"#ffd34e"},g={blocks:[[[0,1,0,0],[1,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,1,0,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[0,1,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:6,color:"#962D3E"},h={blocks:[[[1,1,0,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],[[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],[[0,0,0,0],[1,1,0,0],[0,1,1,0],[0,0,0,0]],[[0,1,0,0],[1,1,0,0],[1,0,0,0],[0,0,0,0]]],startPosition:{x:5,y:2},number:7,color:"#773B6A"},i=4,j=4,k=[b,c,d,e,f,g,h],l=[],m=a.width+4,n=a.height+4,p={},s=!0,v=!1,C=$(this).find(a.canvasSelector),D=C[0].getContext("2d"),H=$(this).find(a.canvasNextPieceSelector),I=H[0].getContext("2d"),O=[-1,0,1,0],P=[0,-1,0,1],_=new Array(n),db=0,eb=1,ib=9*a.speedDecrease+a.minSpeed,jb=ib-(a.speed-1)*a.speedDecrease,qb=$(a.ufoSelector).offset().left+39,rb=$(a.ufoSelector).offset().top+23,tb=!1,ub=!1;xb()})};var loop;$(document).ready(function(){function c(){var a=$(window).height();$(".game").css({height:a+"px"})}function d(a,b){return Math.floor(Math.random()*(b-a+1))+a}function e(){var a=$(window).height(),b=$(window).width();$(".star").each(function(){var c=d(0,b-4),e=d(0,a-4),f=Math.random();$(this).css({top:e+"px"}),$(this).css({left:c+"px"}),$(this).css({opacity:f})})}var a=$(".ufo").offset().left+39,b=$(".ufo").offset().top+23;drawFollowEye("eye-container","eye",40,26,40,a,b,26,26),$(".start").click(function(a){a.preventDefault(),$(window).unbind("mousemove"),$(".ufo").find(".eye-container").remove(),$(".ufo").find(".eye").remove(),clearInterval(loop),$("#game1").find(".canvas-map").css({display:"inline-block"}),$("#game1").tetris(),$("#game1").find(".canvasNextPiece").show(),$(this).hide()}),c(),$(window).resize(function(){c()}),e()});
